{% extends "libraries/library_list.html" %}

{% block breadcrumbs %}
{{ block.super }}
<li class="library"> > <a href="{% url library_detail library.slug %}">{{ library.name }}</a></li>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="/media/js/jqtransform/jqtransform.css" />
<script type="text/javascript" src="/media/js/jqtransform/jquery.jqtransform.js"></script>
<script type="text/javascript" src="/media/js/jquery-ui-1.8rc1.custom.min.js"></script>
<script type="text/javascript" src="/media/js/jquery.blockUI.js"></script>
<script type="text/javascript" src="/media/js/jquery.jeditable.mini.js"></script>
<script type="text/javascript">
	$(function() {
		//find all the forms with the class of jqtransform and then apply the plugin
		$("form.jqtransform").jqTransform();
		
		// Editing Details
		
		$("div.editable .detail").editable(function(value, settings) {
			var detail = $(this);
			if (detail.attr('id') == 'name') {
				postData = {name: value, pk: '{{ library.pk }}'}
			} else if (detail.attr('id') == 'description') {
				postData = {description: value, pk: '{{ library.pk }}'}
			}
			var result = '';
			
			detail.block({
				fadeIn: 10,
				fadeOut: 10,
				css: { 
		            border: 'none',
		            padding: '15px', 
		            backgroundColor: '#000', 
		            '-webkit-border-radius': '10px', 
		            '-moz-border-radius': '10px', 
		            opacity: .5, 
		            color: '#fff' 
		        },
		        message: 'Updating' 
		    });
			
			$.ajax({
				url: '{% url api_save_collection %}',
				data: postData,
				async: false,
				dataType: 'json',
				type: 'POST',
				success: function(data) {
					if (data.meta.success == true) {
						if (detail.attr('id') == 'name') {
							result = data.collection.name;
						} else if (detail.attr('id') == 'description') {
							result = data.collection.description;
						}
						
					} else if(data.meta.success == false) {
						alert(data.meta.error);
					}
				}
			});
			
			detail.unblock();
			
			return result;
		});
				
		// Adding Bookshelves
		
		$("form#new-bookshelf-form").submit(function() {
			
			var form = $(this);
			
			var formData = form.serialize();
			
			form.block({
				fadeIn: 10,
				fadeOut: 10,
				css: { 
		            border: 'none',
		            padding: '15px', 
		            backgroundColor: '#000', 
		            '-webkit-border-radius': '10px', 
		            '-moz-border-radius': '10px', 
		            opacity: .5, 
		            color: '#fff' 
		        },
		        message: 'Adding Bookshelf' 
		    });
			
			$.post('{% url api_save_collection %}', formData, function(data) {
				if (data.meta.success == true) {
					var name = data.collection.name;
					var description = data.collection.description;
					var url = data.collection.url;
					var pk = data.collection.pk;
					$("ul#bookshelf-list").append('<li id="' + pk + '" style="display: none"><a href="' + url + '">' + name + '</a><span class="delete">delete</span></li>');
					$("li#" + pk).slideDown('200');
					
					$("#" + pk).hover(bookshelf_hover_over, bookshelf_hover_out);
					$("#" + pk + " span.delete").click(bookshelf_click_delete);
					
					$.growlUI('Bookshelf Added', 'Your bookshelf was added successfully');
										
					form.unblock();
					
				} else if(data.meta.success == false) {
					form.unblock();
					$.blockUI({ css: { 
			            border: 'none', 
			            padding: '15px', 
			            backgroundColor: '#000', 
			            '-webkit-border-radius': '10px', 
			            '-moz-border-radius': '10px', 
			            opacity: .5, 
			            color: '#fff' 
			        }, message: '<h1>There was an error adding the Bookshelf</h1><p>' + data.meta.error + '</p><input type="button" value="OK" id="blockUI-OK" />' });
			        
			        $("#blockUI-OK").click(function() {
			        	$.unblockUI();
			        	return false;
			        });
				}
			}, "json");
			
			form.find(':input[name="name"]').val('');
			
			return false;
		});
		
		// Bookshelf List
		
		function bookshelf_hover_over() {
			$(this).find('span.delete, span.really').css('display', 'inline');
		}
		
		function bookshelf_hover_out() {
			$(this).find('span.delete').css('display', 'none');
			$(this).find('span.really').remove();
		}
		
		function bookshelf_click_delete() {
			var bookshelf_row = $(this).parent();
			var bookshelf_pk = bookshelf_row.attr("id");
			
			if (bookshelf_row.find('span.really').length == 0) {
				
				bookshelf_row.append('<span class="really">really</spa>');
			
				var really = bookshelf_row.find('span.really');
				
				really.css('display', 'inline');
				
				really.click(function() {
					$.post('{% url api_delete_collection %}', {collection_pk: bookshelf_pk}, function(data) {
						if (data.meta.success == true) {
							bookshelf_row.slideUp('200', function() {
								$(this).remove();
							});
							$.growlUI('Bookshelf Deleted', 'Your bookshelf was deleted successfully');
						} else if(data.meta.success == false) {
							$.blockUI({ css: {
								'class': 'specialclass',
					            border: 'none', 
					            padding: '15px', 
					            backgroundColor: '#000', 
					            '-webkit-border-radius': '10px', 
					            '-moz-border-radius': '10px', 
					            opacity: .5, 
					            color: '#fff' 
					        }, message: '<h1>There was an error deleting the Bookshelf</h1><p>' + data.meta.error + '</p><input type="button" value="OK" id="blockUI-OK" />' });
					        
					        $("#blockUI-OK").click(function() {
					        	$.unblockUI();
					        	return false;
					        });
						}
					}, "json");
				});
				
			}
		}
		
		$("ul#bookshelf-list li").append('<span class="delete">delete</span>');
			  
		$("ul#bookshelf-list li").hover(bookshelf_hover_over, bookshelf_hover_out);
			  
		$("ul#bookshelf-list li span.delete").click(bookshelf_click_delete);
	});
</script>
{% endblock %}

{% block content %}
	<div class="section">
		<div class="inner">
			<div class="editable">
				<h2 id="name" class="detail">{{ library.name }}</h2>
			</div>
			<div class="editable">
				<p id="description" class="detail">{{ library.description }}</p>
			</div>
			<ul id="bookshelf-list" class="collection-list">
				<li><a href="{{ library.get_absolute_url }}{{ unsorted_bin.slug }}/">{{ unsorted_bin.slug }}</a></li>
				{% for bookshelf in library.children.all %}
					<li id="{{ bookshelf.pk }}"><a href="{{ bookshelf.get_absolute_url }}">{{ bookshelf.name }}</a></li>
				{% endfor %}
			</ul>
		</div>
	</div>
	
	<div class="section">
		<div class="inner">
			<h3>Create a new <span class="bookshelf">Bookshelf</span></h3>
			<form id="new-bookshelf-form" action="" method="post" class="jqtransform">
				<input type="hidden" name="parent_pk" id="parent_pk" value="{{ library.pk }}" />
				<input type="hidden" name="collection_type" id="collection_type" value="bookshelf" />
				<div class="rowElem">
					{{ form.name }}
				</div>
				<div class="rowElem">
					<input type="submit" value="Create" />
				</div>
			</form>			
			<div class="icon-link clearfix">
				<img src="/media/images/icons/milky/book.png" />
				<h3 class="compact">Add a <span class="book">Book</span> to this Libraries Unsorted Bin</h3>
				<p><a href="{% url add_books %}?c={{ library.pk }}">Add a Book</a></p>
			</div>
		</div>
	</div>
	
	<div id="bookshelf-delete" class="dialog" title="Delete this Bookshelf?">
		<p><span class="ui-icon ui-icon-alert" style="float:left; margin:3px 7px 30px 0;"></span>This bookshelf will be permanently deleted. Are you sure?</p>
	</div>
	
	<div id="bookshelf-delete-error" class="dialog" title="Problem deleting Library!">
		<p class="error-message"><span class="ui-icon ui-icon-alert" style="float:left; margin:2px 7px 30px 0;"></span></p>
	</div>
{% endblock %}