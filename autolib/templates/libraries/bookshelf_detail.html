{% extends "libraries/library_detail.html" %}

{% block breadcrumbs %}
	{{ block.super }}
	{% if bookshelf %}
		<li class="bookshelf"> > <a href="{% url bookshelf_detail library.slug, bookshelf.slug %}">{{ bookshelf.name }}</a></li>
	{% else %}
		<li class="bookshelf"> > <a href="{% url library_detail library.slug %}{{ unsorted_bin.slug }}/">{{ unsorted_bin.value }}</a></li>
	{% endif %}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="/media/js/jqtransform/jqtransform.css" />
<script type="text/javascript" src="/media/js/jqtransform/jquery.jqtransform.js"></script>
<script type="text/javascript" src="/media/js/jquery.jeditable.mini.js"></script>
<script type="text/javascript" src="/media/js/jquery.blockUI.js"></script>
<script type="text/javascript">
	$(function() {
		// Find all the forms with the class of jqtransform and then apply the plugin
		$("form.jqtransform").jqTransform();
		
		// Editing Details
		
		$("div.editable .detail").editable(function(value, settings) {
			var detail = $(this);
			if (detail.attr('id') == 'name') {
				postData = {name: value, pk: '{{ bookshelf.pk }}'}
			} else if (detail.attr('id') == 'description') {
				postData = {description: value, pk: '{{ bookshelf.pk }}'}
			}
			var result = '';
			
			detail.block({
				fadeIn: 10,
				fadeOut: 10,
				css: { 
		            border: 'none',
		            padding: '15px', 
		            backgroundColor: '#000', 
		            '-webkit-border-radius': '10px', 
		            '-moz-border-radius': '10px', 
		            opacity: .5, 
		            color: '#fff' 
		        },
		        message: 'Updating' 
		    });
			
			$.ajax({
				url: '{% url api_save_collection %}',
				data: postData,
				async: false,
				dataType: 'json',
				type: 'POST',
				success: function(data) {
					if (data.meta.success == true) {
						if (detail.attr('id') == 'name') {
							result = data.collection.name;
						} else if (detail.attr('id') == 'description') {
							result = data.collection.description;
						}
						
					} else if(data.meta.success == false) {
						alert(data.meta.error);
					}
				}
			});
			
			detail.unblock();
			
			return result;
		});
		
		// Adding Bookshelves
		
		$("form#new-bookshelf-form").submit(function() {
			
			var form = $(this);
			
			form.find().attr('disabled', 'disabled');
			
			$.post('{% url api_save_collection %}', form.serialize(), function(data) {
				if (data.meta.success == true) {
					var name = data.bookshelf.name;
					var description = data.bookshelf.description;
					var url = data.bookshelf.url;
					$("ul#bookshelf-list").append('<li><a href="' + url + '">' + name + '</a></li>');
				} else if(data.meta.success == false) {
					alert(data.meta.error);
				}
			}, "json");
			
			form.find().attr('disabled', '');
			form.find(':input[name="name"]').val('');
			
			return false;
		});
	});
</script>
{% endblock %}

{% block content %}
	<div class="section">
		<div class="inner">
			{% if bookshelf %}
				<div class="editable">
					<h2 id="name" class="detail">{{ bookshelf.name }}</h2>
				</div>
				<div class="editable">
					<p id="description" class="detail">{{ bookshelf.description }}</p>
				</div>
				{% if bookshelf.books.all %}
					<ul>
						{% for book in bookshelf.books.all %}
							<li><a href="{{ book.get_absolute_url }}">{{ book.title }}</a> by {{ book.author }}</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="error">So there are no books in this bookshelf yet, you should be ashamed of yourself!</p>
				{% endif %}
			{% else %}
				<h2>{{ unsorted_bin.value }}</h2>
				<p>{{ unsorted_bin_description.value }}</p>
				{% if library.books.all %}
					<ul>
						{% for book in library.books.all %}
							<li><a href="{{ book.get_absolute_url }}">{{ book.title }}</a> by {{ book.author }}</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="error">So there are no books in this bookshelf yet, you should be ashamed of yourself!</p>
				{% endif %}
			{% endif %}
		</div>
	</div>
{% endblock %}